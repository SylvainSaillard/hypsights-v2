# Fast Search Monitoring - R√©sum√© Ex√©cutif

## üéØ Objectif

Surveiller automatiquement les Fast Searches et **rembourser le quota utilisateur** si :
- Le workflow N8n plante (pas de r√©sultat apr√®s 10 minutes)
- Aucun fournisseur n'est trouv√©

## üìä Architecture en 3 Composants

### 1Ô∏è‚É£ Base de Donn√©es (Migration SQL)
```
Table solutions:
  ‚îú‚îÄ fast_search_status         ‚Üí 'pending', 'success', 'no_results', 'refunded'
  ‚îú‚îÄ fast_search_launched_at    ‚Üí Timestamp de lancement
  ‚îú‚îÄ fast_search_checked_at     ‚Üí Timestamp de v√©rification (10 min apr√®s)
  ‚îú‚îÄ fast_search_refunded       ‚Üí Boolean (quota rembours√©?)
  ‚îî‚îÄ fast_search_refund_reason  ‚Üí Raison du remboursement

Table fast_search_monitoring_logs:
  ‚îî‚îÄ Historique de toutes les v√©rifications et remboursements

Fonctions SQL:
  ‚îú‚îÄ get_fast_searches_to_check()     ‚Üí Liste des Fast Searches √† v√©rifier
  ‚îú‚îÄ count_suppliers_for_solution()   ‚Üí Compte les fournisseurs trouv√©s
  ‚îî‚îÄ refund_fast_search()             ‚Üí Rembourse le quota
```

### 2Ô∏è‚É£ Edge Functions

**fast-search-handler** (modifi√©e)
```typescript
Au lancement d'une Fast Search:
  1. Initialise fast_search_status = 'pending'
  2. Enregistre fast_search_launched_at = NOW()
  3. Appelle le webhook N8n
  4. Retourne success au frontend
```

**fast-search-monitor** (nouvelle)
```typescript
Appel√©e toutes les 5 minutes par un cron job:
  1. R√©cup√®re les Fast Searches lanc√©es il y a >10 min
  2. Pour chaque Fast Search:
     - Compte les fournisseurs trouv√©s
     - Si 0 fournisseur ‚Üí Rembourse automatiquement
     - Si >0 fournisseurs ‚Üí Marque comme success
     - Met √† jour le statut
     - Cr√©e un log
```

### 3Ô∏è‚É£ Service Frontend

**fastSearchMonitorService.ts**
```typescript
Fonctions disponibles:
  ‚îú‚îÄ checkAllPendingSearches()           ‚Üí V√©rifier toutes les Fast Searches
  ‚îú‚îÄ checkSingleSearch(solutionId)       ‚Üí V√©rifier une Fast Search sp√©cifique
  ‚îú‚îÄ getUserMonitoringLogs(userId)       ‚Üí R√©cup√©rer les logs utilisateur
  ‚îú‚îÄ subscribeToFastSearchStatus()       ‚Üí S'abonner aux changements en temps r√©el
  ‚îî‚îÄ isSolutionRefunded(solutionId)      ‚Üí V√©rifier si rembours√©e
```

## üîÑ Flux Complet

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. USER LANCE UNE FAST SEARCH                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ fast-search-handler                                              ‚îÇ
‚îÇ ‚îú‚îÄ Initialise monitoring (status='pending')                     ‚îÇ
‚îÇ ‚îú‚îÄ Enregistre launched_at = NOW()                               ‚îÇ
‚îÇ ‚îú‚îÄ Appelle webhook N8n                                          ‚îÇ
‚îÇ ‚îî‚îÄ Retourne success                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. WORKFLOW N8N RECHERCHE DES FOURNISSEURS                      ‚îÇ
‚îÇ    (Processus asynchrone - peut prendre plusieurs minutes)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. APR√àS 10 MINUTES - V√âRIFICATION AUTOMATIQUE                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Cron Job (toutes les 5 min)                                     ‚îÇ
‚îÇ ‚îî‚îÄ Appelle fast-search-monitor                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ fast-search-monitor                                              ‚îÇ
‚îÇ ‚îú‚îÄ R√©cup√®re Fast Searches lanc√©es il y a >10 min               ‚îÇ
‚îÇ ‚îú‚îÄ Compte les fournisseurs trouv√©s                             ‚îÇ
‚îÇ ‚îî‚îÄ D√©cide: Success ou Remboursement                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚Üì                                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ CAS 1: SUCC√àS        ‚îÇ          ‚îÇ CAS 2: √âCHEC         ‚îÇ
‚îÇ (>0 fournisseurs)    ‚îÇ          ‚îÇ (0 fournisseur)      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚úì Status = 'success' ‚îÇ          ‚îÇ ‚úó Status = 'refunded'‚îÇ
‚îÇ ‚úì Pas de remboursemt ‚îÇ          ‚îÇ ‚úì Remboursement auto ‚îÇ
‚îÇ ‚úì Quota consomm√©     ‚îÇ          ‚îÇ ‚úì Quota lib√©r√©       ‚îÇ
‚îÇ ‚úì Log cr√©√©           ‚îÇ          ‚îÇ ‚úì Log + raison       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìã D√©ploiement en 4 √âtapes

### √âtape 1: Migration SQL
```bash
supabase db push
# Ou via Dashboard: SQL Editor ‚Üí Coller migration ‚Üí Run
```

### √âtape 2: D√©ployer Edge Functions
```bash
supabase functions deploy fast-search-monitor --project-ref lmqagaenmseopcctkrwv
supabase functions deploy fast-search-handler --project-ref lmqagaenmseopcctkrwv
```

### √âtape 3: Configurer Cron Job
**Option A: n8n Workflow**
- Trigger: Schedule (5 minutes)
- HTTP Request: GET fast-search-monitor

**Option B: Supabase pg_cron**
```sql
SELECT cron.schedule('fast-search-monitor', '*/5 * * * *', $$
  SELECT net.http_get(url := 'https://.../fast-search-monitor?action=check_all&delay=10');
$$);
```

### √âtape 4: Tester
```bash
# Test manuel
curl "https://lmqagaenmseopcctkrwv.supabase.co/functions/v1/fast-search-monitor?action=check_all&delay=10"
```

## üîç Monitoring

### Requ√™tes SQL Utiles

**Taux de remboursement (derni√®res 24h)**
```sql
SELECT 
  COUNT(*) FILTER (WHERE fast_search_refunded = true) * 100.0 / COUNT(*) as refund_rate
FROM solutions
WHERE fast_search_launched_at > NOW() - INTERVAL '24 hours';
```

**Fast Searches en attente**
```sql
SELECT 
  id, title, 
  EXTRACT(EPOCH FROM (NOW() - fast_search_launched_at)) / 60 as minutes_elapsed
FROM solutions
WHERE fast_search_launched_at IS NOT NULL
  AND fast_search_checked_at IS NULL
  AND fast_search_refunded = false;
```

**Derniers remboursements**
```sql
SELECT * FROM fast_search_monitoring_logs
WHERE refunded = true
ORDER BY created_at DESC
LIMIT 10;
```

## ‚ö†Ô∏è Points d'Attention

### ‚úÖ Avantages
- **Automatique** - Aucune intervention manuelle
- **√âquitable** - Utilisateur rembours√© si √©chec
- **Tra√ßable** - Tous les √©v√©nements logg√©s
- **Temps r√©el** - V√©rification toutes les 5 minutes

### ‚ö†Ô∏è Limitations
- D√©lai de 10 minutes avant v√©rification (configurable)
- N√©cessite un cron job actif
- Rembourse m√™me si workflow N8n r√©ussit mais sans r√©sultat

### üîß Maintenance
- Surveiller le taux de remboursement (alerte si >20%)
- V√©rifier que le cron job fonctionne
- Analyser les raisons de remboursement

## üìö Documentation Compl√®te

- **Guide technique d√©taill√©**: `docs/FAST_SEARCH_MONITORING.md`
- **Guide de d√©ploiement**: `docs/DEPLOYMENT_FAST_SEARCH_MONITORING.md`
- **Code source**:
  - Migration: `supabase/migrations/20250117000000_add_fast_search_monitoring.sql`
  - Edge Function: `supabase/functions/fast-search-monitor/index.ts`
  - Service Frontend: `src/services/fastSearchMonitorService.ts`

## üÜò Support

**En cas de probl√®me:**
1. V√©rifier les logs Supabase: `supabase functions logs fast-search-monitor`
2. V√©rifier la table: `SELECT * FROM fast_search_monitoring_logs ORDER BY created_at DESC`
3. Test manuel: `curl .../fast-search-monitor?action=check_all`
4. Consulter la documentation compl√®te

---

**R√©sum√© en une phrase:**  
*Syst√®me automatique qui v√©rifie toutes les Fast Searches apr√®s 10 minutes et rembourse le quota si aucun fournisseur n'est trouv√©.*
