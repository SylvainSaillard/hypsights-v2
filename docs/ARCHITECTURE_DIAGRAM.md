# Fast Search Monitoring - Architecture Visuelle

## ğŸ—ï¸ Vue d'Ensemble du SystÃ¨me

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         HYPSIGHTS V2 - FAST SEARCH                       â”‚
â”‚                         MONITORING & REFUND SYSTEM                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FRONTEND LAYER                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  EnhancedChatViewâ”‚         â”‚  SolutionsPanel  â”‚                     â”‚
â”‚  â”‚                  â”‚         â”‚                  â”‚                     â”‚
â”‚  â”‚  - Launch Fast   â”‚         â”‚  - Display       â”‚                     â”‚
â”‚  â”‚    Search        â”‚         â”‚    Solutions     â”‚                     â”‚
â”‚  â”‚  - Show Status   â”‚         â”‚  - Show Quota    â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚           â”‚                            â”‚                                â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                        â”‚                                                â”‚
â”‚                        â†“                                                â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚           â”‚ fastSearchMonitorServiceâ”‚                                   â”‚
â”‚           â”‚                        â”‚                                   â”‚
â”‚           â”‚ - checkSingleSearch()  â”‚                                   â”‚
â”‚           â”‚ - getUserLogs()        â”‚                                   â”‚
â”‚           â”‚ - subscribeToStatus()  â”‚                                   â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                        â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ HTTP/WebSocket
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        â”‚         EDGE FUNCTIONS LAYER                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        â”‚                                                â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚           â”‚  fast-search-handler   â”‚                                   â”‚
â”‚           â”‚                        â”‚                                   â”‚
â”‚           â”‚  1. Authenticate user  â”‚                                   â”‚
â”‚           â”‚  2. Initialize monitor â”‚                                   â”‚
â”‚           â”‚  3. Call N8n webhook   â”‚                                   â”‚
â”‚           â”‚  4. Return success     â”‚                                   â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                        â”‚                                                â”‚
â”‚                        â”‚ Updates                                        â”‚
â”‚                        â†“                                                â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚           â”‚  Database (Supabase)   â”‚                                   â”‚
â”‚           â”‚                        â”‚                                   â”‚
â”‚           â”‚  solutions table:      â”‚                                   â”‚
â”‚           â”‚  - fast_search_status  â”‚                                   â”‚
â”‚           â”‚  - launched_at         â”‚                                   â”‚
â”‚           â”‚  - checked_at          â”‚                                   â”‚
â”‚           â”‚  - refunded            â”‚                                   â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                        â”‚                                                â”‚
â”‚                        â”‚ Reads                                          â”‚
â”‚                        â†“                                                â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚           â”‚ fast-search-monitor    â”‚â—„â”€â”€â”€â”€â”€â”€â”€ Cron Job (5 min)         â”‚
â”‚           â”‚                        â”‚                                   â”‚
â”‚           â”‚  1. Get pending checks â”‚                                   â”‚
â”‚           â”‚  2. Count suppliers    â”‚                                   â”‚
â”‚           â”‚  3. Decide action      â”‚                                   â”‚
â”‚           â”‚  4. Update status      â”‚                                   â”‚
â”‚           â”‚  5. Refund if needed   â”‚                                   â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                        â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Calls SQL Functions
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        â”‚         DATABASE LAYER                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        â”‚                                                â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚           â”‚   PostgreSQL Functions â”‚                                   â”‚
â”‚           â”‚                        â”‚                                   â”‚
â”‚           â”‚  get_fast_searches_    â”‚                                   â”‚
â”‚           â”‚    to_check()          â”‚                                   â”‚
â”‚           â”‚                        â”‚                                   â”‚
â”‚           â”‚  count_suppliers_      â”‚                                   â”‚
â”‚           â”‚    for_solution()      â”‚                                   â”‚
â”‚           â”‚                        â”‚                                   â”‚
â”‚           â”‚  refund_fast_search()  â”‚                                   â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                        â”‚                                                â”‚
â”‚                        â”‚ Operates on                                    â”‚
â”‚                        â†“                                                â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚           â”‚   Database Tables      â”‚                                   â”‚
â”‚           â”‚                        â”‚                                   â”‚
â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                   â”‚
â”‚           â”‚  â”‚   solutions      â”‚  â”‚                                   â”‚
â”‚           â”‚  â”‚  - id            â”‚  â”‚                                   â”‚
â”‚           â”‚  â”‚  - status        â”‚  â”‚                                   â”‚
â”‚           â”‚  â”‚  - launched_at   â”‚  â”‚                                   â”‚
â”‚           â”‚  â”‚  - checked_at    â”‚  â”‚                                   â”‚
â”‚           â”‚  â”‚  - refunded      â”‚  â”‚                                   â”‚
â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                   â”‚
â”‚           â”‚                        â”‚                                   â”‚
â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                   â”‚
â”‚           â”‚  â”‚ monitoring_logs  â”‚  â”‚                                   â”‚
â”‚           â”‚  â”‚  - solution_id   â”‚  â”‚                                   â”‚
â”‚           â”‚  â”‚  - check_type    â”‚  â”‚                                   â”‚
â”‚           â”‚  â”‚  - status        â”‚  â”‚                                   â”‚
â”‚           â”‚  â”‚  - refunded      â”‚  â”‚                                   â”‚
â”‚           â”‚  â”‚  - details       â”‚  â”‚                                   â”‚
â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                   â”‚
â”‚           â”‚                        â”‚                                   â”‚
â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                   â”‚
â”‚           â”‚  â”‚ supplier_matches â”‚  â”‚                                   â”‚
â”‚           â”‚  â”‚  - solution_id   â”‚  â”‚                                   â”‚
â”‚           â”‚  â”‚  - supplier_id   â”‚  â”‚                                   â”‚
â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                   â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         EXTERNAL SERVICES                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚   N8n Workflow   â”‚         â”‚   Cron Service   â”‚                     â”‚
â”‚  â”‚                  â”‚         â”‚                  â”‚                     â”‚
â”‚  â”‚  - Search        â”‚         â”‚  - Trigger every â”‚                     â”‚
â”‚  â”‚    suppliers     â”‚         â”‚    5 minutes     â”‚                     â”‚
â”‚  â”‚  - Insert data   â”‚         â”‚  - Call monitor  â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Flux de DonnÃ©es DÃ©taillÃ©

### 1. Lancement d'une Fast Search

```
User clicks "Fast Search"
    â”‚
    â†“
EnhancedChatView.startFastSearch()
    â”‚
    â†“
fastSearchService.startFastSearchFromSolution(briefId, solutionId)
    â”‚
    â†“ HTTP POST
fast-search-handler Edge Function
    â”‚
    â”œâ”€â†’ Authenticate user
    â”‚
    â”œâ”€â†’ Initialize monitoring:
    â”‚   UPDATE solutions SET
    â”‚     fast_search_status = 'pending',
    â”‚     fast_search_launched_at = NOW()
    â”‚
    â”œâ”€â†’ Call N8n webhook
    â”‚   POST https://n8n-hypsights.proxiwave.app/webhook/searchsupplier
    â”‚
    â””â”€â†’ Return { success: true, monitoring_enabled: true }
```

### 2. Monitoring Automatique (aprÃ¨s 10 minutes)

```
Cron Job (every 5 minutes)
    â”‚
    â†“ HTTP GET
fast-search-monitor Edge Function
    â”‚
    â”œâ”€â†’ Call get_fast_searches_to_check(10)
    â”‚   SELECT solutions WHERE
    â”‚     launched_at < NOW() - 10 minutes
    â”‚     AND checked_at IS NULL
    â”‚
    â”œâ”€â†’ For each solution:
    â”‚   â”‚
    â”‚   â”œâ”€â†’ Call count_suppliers_for_solution(solution_id)
    â”‚   â”‚   SELECT COUNT(*) FROM supplier_matches
    â”‚   â”‚   WHERE solution_id = ?
    â”‚   â”‚
    â”‚   â”œâ”€â†’ IF suppliers_found > 0:
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â†’ UPDATE solutions SET
    â”‚   â”‚   â”‚     fast_search_status = 'success',
    â”‚   â”‚   â”‚     fast_search_checked_at = NOW()
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â†’ INSERT INTO monitoring_logs
    â”‚   â”‚         (status='success', refunded=false)
    â”‚   â”‚
    â”‚   â””â”€â†’ ELSE (suppliers_found = 0):
    â”‚       â”‚
    â”‚       â”œâ”€â†’ Call refund_fast_search(solution_id)
    â”‚       â”‚   â”‚
    â”‚       â”‚   â”œâ”€â†’ UPDATE solutions SET
    â”‚       â”‚   â”‚     fast_search_refunded = true,
    â”‚       â”‚   â”‚     fast_search_launched_at = NULL,  â† LibÃ¨re le quota
    â”‚       â”‚   â”‚     fast_search_status = 'refunded'
    â”‚       â”‚   â”‚
    â”‚       â”‚   â””â”€â†’ INSERT INTO monitoring_logs
    â”‚       â”‚         (status='refunded', refunded=true)
    â”‚       â”‚
    â”‚       â””â”€â†’ Quota restored for user
    â”‚
    â””â”€â†’ Return { checked: N, results: [...] }
```

### 3. Notification Temps RÃ©el

```
Database UPDATE on solutions.fast_search_status
    â”‚
    â†“ Supabase Realtime
Frontend subscribeToFastSearchStatus()
    â”‚
    â”œâ”€â†’ IF status = 'refunded':
    â”‚   â”‚
    â”‚   â””â”€â†’ Show notification:
    â”‚         "Fast Search refunded - quota restored"
    â”‚
    â””â”€â†’ IF status = 'success':
        â”‚
        â””â”€â†’ Refresh supplier results
```

## ğŸ“Š Ã‰tats du SystÃ¨me

### Statuts d'une Fast Search

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   INITIAL   â”‚  fast_search_launched_at = NULL
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ User launches Fast Search
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PENDING   â”‚  fast_search_status = 'pending'
â”‚             â”‚  fast_search_launched_at = NOW()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Wait 10 minutes
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CHECKING   â”‚  Cron job triggers verification
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â†“                 â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SUCCESS   â”‚   â”‚ NO_RESULTS  â”‚   â”‚   TIMEOUT   â”‚
â”‚             â”‚   â”‚             â”‚   â”‚             â”‚
â”‚ >0 supplier â”‚   â”‚ 0 supplier  â”‚   â”‚ Error       â”‚
â”‚ No refund   â”‚   â”‚ REFUNDED    â”‚   â”‚ REFUNDED    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cycle de Vie d'un Quota

```
User has 3 Fast Searches available
    â”‚
    â†“ Launch Fast Search
User has 2 Fast Searches available
    â”‚
    â”‚ fast_search_launched_at = NOW()
    â”‚ (Quota consumed)
    â”‚
    â†“ Wait 10 minutes
Monitoring checks results
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                 â†“                 â†“
SUCCESS           NO_RESULTS        TIMEOUT
Quota stays       Quota refunded    Quota refunded
consumed          â”‚                 â”‚
                  â†“                 â†“
            fast_search_launched_at = NULL
            User has 3 Fast Searches available again
```

## ğŸ” SÃ©curitÃ© et Permissions

### RLS Policies

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TABLE: solutions                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Policy: user_access_solutions                              â”‚
â”‚  â”œâ”€ SELECT, UPDATE, DELETE                                  â”‚
â”‚  â””â”€ WHERE user_id = auth.uid() OR role = 'admin'           â”‚
â”‚                                                              â”‚
â”‚  Policy: service_role_solutions                             â”‚
â”‚  â”œâ”€ ALL operations                                          â”‚
â”‚  â””â”€ TO service_role                                         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              TABLE: fast_search_monitoring_logs              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Policy: users_view_own_logs                                â”‚
â”‚  â”œâ”€ SELECT                                                  â”‚
â”‚  â””â”€ WHERE user_id = auth.uid()                              â”‚
â”‚                                                              â”‚
â”‚  Policy: service_role_full_access                           â”‚
â”‚  â”œâ”€ ALL operations                                          â”‚
â”‚  â””â”€ TO service_role                                         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ˆ Performance et Optimisation

### Indexes CrÃ©Ã©s

```sql
-- Index pour les requÃªtes de monitoring
CREATE INDEX idx_solutions_fast_search_monitoring 
ON solutions(fast_search_launched_at, fast_search_status, fast_search_checked_at)
WHERE fast_search_launched_at IS NOT NULL;

-- Index pour les logs
CREATE INDEX idx_fast_search_logs_solution 
ON fast_search_monitoring_logs(solution_id, created_at DESC);

CREATE INDEX idx_fast_search_logs_user 
ON fast_search_monitoring_logs(user_id, created_at DESC);
```

### RequÃªtes OptimisÃ©es

```
get_fast_searches_to_check()
    â†“
Uses: idx_solutions_fast_search_monitoring
    â†“
Filters: launched_at, checked_at, refunded
    â†“
Returns: Only solutions needing check
    â†“
Performance: O(log n) with index
```

## ğŸ” Monitoring et ObservabilitÃ©

### Logs Disponibles

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LOGGING LAYERS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. Edge Function Logs (Supabase)                           â”‚
â”‚     â”œâ”€ fast-search-handler                                  â”‚
â”‚     â”‚  â””â”€ Initialization events                             â”‚
â”‚     â””â”€ fast-search-monitor                                  â”‚
â”‚        â””â”€ Check and refund events                           â”‚
â”‚                                                              â”‚
â”‚  2. Database Logs (monitoring_logs table)                   â”‚
â”‚     â”œâ”€ Every check recorded                                 â”‚
â”‚     â”œâ”€ Every refund recorded                                â”‚
â”‚     â””â”€ Queryable with SQL                                   â”‚
â”‚                                                              â”‚
â”‚  3. Application Logs (Frontend)                             â”‚
â”‚     â”œâ”€ User actions                                         â”‚
â”‚     â””â”€ Real-time updates                                    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### MÃ©triques CollectÃ©es

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KEY METRICS                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Business Metrics:                                           â”‚
â”‚  â”œâ”€ Fast Search success rate                                â”‚
â”‚  â”œâ”€ Refund rate                                             â”‚
â”‚  â”œâ”€ Average suppliers per search                            â”‚
â”‚  â””â”€ User satisfaction (indirect)                            â”‚
â”‚                                                               â”‚
â”‚  Technical Metrics:                                          â”‚
â”‚  â”œâ”€ Average check time                                      â”‚
â”‚  â”œâ”€ Cron job reliability                                    â”‚
â”‚  â”œâ”€ Database query performance                              â”‚
â”‚  â””â”€ Edge Function response time                             â”‚
â”‚                                                               â”‚
â”‚  Operational Metrics:                                        â”‚
â”‚  â”œâ”€ Pending checks count                                    â”‚
â”‚  â”œâ”€ Stuck searches (>15 min)                                â”‚
â”‚  â”œâ”€ Daily refund volume                                     â”‚
â”‚  â””â”€ Error rate                                              â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Architecture Version:** 1.0.0  
**Last Updated:** 17 janvier 2025  
**Status:** âœ… Production Ready
